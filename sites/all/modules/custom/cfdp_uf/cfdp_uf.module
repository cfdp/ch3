<?php
/*
 * Implementation of hook_form_alter()
 */
function cfdp_uf_form_alter(&$form, &$form_state, $form_id){
  switch ($form_id) {
    case 'brevkasse_node_form':
      // Brevkasse-status: Iterate over the terms and unset any closed or archived terms from the select list
      $brevk_terms = taxonomy_term_load_multiple(array(), array('vid' => '3'));
      foreach ($brevk_terms as $key => $value) {
          if (count($value->field_taxonomy_brevk_status) > 0){
            $status = $value->field_taxonomy_brevk_status['und']['0']['value'];
            if ($status === "archived" || $status === "temp_closed") {
              $tid = $value ->tid;
              unset($form['field_brevk_kategori']['und']['#options'][$tid]);
            }
          }
      }

      // Brevkasse title validation, alowed charaters (a to z, 0 to 9, ?, !, ., ,, -,)
      $form['#validate'][] = 'cfdp_uf_brevkasse_title_form_validate';
      break;
/*    case 'body_secret_node_form':
      $form['#submit'][] = 'cfdp_uf_custom_status_message';
      break;*/
  }
}

/*
*  Set custom status message
*
*/
/*function cfdp_uf_custom_status_message(&$form, $form_state) {
  // To hide message
  drupal_get_messages('status');
  //To override message
  drupal_set_message(t('Tak fordi du delte din hemmelighed med cyberhus.dk!'), 'status');
 }*/


  /* 
  *  If all the chars in the string are chars that the URL cleaner will remove, title is invalid. 
  *  The title needs to have AT LEAST ONE char that is allowed by the cleaner.
  */
function cfdp_uf_brevkasse_title_form_validate($form, &$form_state) {
  $title = $form_state['values']['title'];
  $title_length = strlen($form_state['values']['title']);
  $title_characters = str_split($form_state['values']['title']);
  $title_valid = FALSE;

  if($title_length >= 3){
    foreach($title_characters as $char){
      if(preg_match('/[a-zåæø0-9]/i', $char)){
      
        $title_valid = TRUE;
      }
    }

      if(!$title_valid){
        form_set_error('title', t('You have invalid charaters in your title.'));
      }
    
  }else{
    form_set_error('title', t('Your title is too short.'));
  }
}

function cfdp_uf_node_update($node) {
  global $user;
  //if it is the first time the brevkasse node is edited by a counselor (=the author is anonymous), change the author to the current user
  if (($node->uid == 0) && ($node->type == "brevkasse") && cfdp_uf_user_has_role('Brevkasserådgiver')) {
    $node->uid = $user->uid;
    node_save($node);
    drupal_set_message(t('Author of Brevkasse node changed from anonymous to ').$user->name);
  }
}

/**
* Check to see if a user has been assigned a certain role.
*
* @param $role
*   The name of the role you're trying to find.
* @param $user
*   The user object for the user you're checking; defaults to the current user.
* @return
*   TRUE if the user object has the role, FALSE if it does not.
*/
function cfdp_uf_user_has_role($role, $user = NULL) {
  if ($user == NULL) {
    global $user;
  }
  if (is_array($user->roles) && in_array($role, array_values($user->roles))) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Check if the current time is within opening hours
 * @return
 *   TRUE if the current time is within opening hours
 * @todo opening hours should be configurable fields in the administration
 */
function cfdp_uf_open_to_posts() {
  $open = true;
  $closingtime = 22;
  $openingtime = 9;
  $timezone = new DateTimeZone( "Europe/Copenhagen" );
  $date = new DateTime();
  $date->setTimezone($timezone);
  $present_hour =  $date->format('H');
  if($present_hour > ($closingtime -1) || $present_hour < $openingtime ){
    $open = false;
  }
  return $open;
}
